services:
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: appdb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - svs-network

  backend:
    image: ${BACKEND_IMAGE}
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      # Database Config
      DB_URL: jdbc:postgresql://postgres:5432/appdb
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # Mail Config
      MAIL_FROM: ${MAIL_FROM}
      POSTMARK_API_URL: ${POSTMARK_API_URL}
      POSTMARK_TOKEN: ${POSTMARK_TOKEN}
      ADMIN_VERIFICATION_EMAIL: ${ADMIN_VERIFICATION_EMAIL}
      
      # Security & JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TTL: ${JWT_ACCESS_TTL}
      JWT_REFRESH_TTL: ${JWT_REFRESH_TTL}
      
      # Server & App
      SERVER_PORT: 8080
      STORAGE_BASE_PATH: ${STORAGE_BASE_PATH}
      AGENT_DUMMY_PASSWORD_ENABLED: ${AGENT_DUMMY_PASSWORD_ENABLED}
      AGENT_DUMMY_PASSWORD_VALUE: ${AGENT_DUMMY_PASSWORD_VALUE}
      OTP_EXPIRY_MINUTES: ${OTP_EXPIRY_MINUTES}
      OTP_HARDCODED: ${OTP_HARDCODED}
      OTP_HARDCODED_VALUE: ${OTP_HARDCODED_VALUE}
    networks:
      - svs-network

  frontend:
    image: ${FRONTEND_IMAGE}
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      REACT_APP_API_URL: ""
    volumes:
      # Frontend image requires certs internally
      - /home/svs-admin/svs-deploy/certs:/etc/nginx/certs:ro
    networks:
      - svs-network

networks:
  svs-network:
    driver: bridge

volumes:
  postgres_data:
